<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>PWA QR Scanner</title>

  <link rel="manifest" href="/manifest.json">
  <meta name="theme-color" content="#0b5fff">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/html5-qrcode/2.3.8/html5-qrcode.min.js"></script>

  <style>
    :root{font-family:system-ui,Segoe UI,Roboto,Arial;}
    body{max-width:900px;margin:18px auto;padding:12px;}
    header{display:flex;justify-content:space-between;align-items:center}
    h1{font-size:1.1rem;margin:0}
    button{padding:8px 12px;border-radius:8px;border:1px solid #ccc;background:white;cursor:pointer}
    .controls{display:flex;gap:8px;margin:12px 0}
    #reader{width:100%;max-width:640px;height:360px;background:#111;color:#fff;display:flex;align-items:center;justify-content:center}
    table{width:100%;border-collapse:collapse;margin-top:12px}
    th,td{border:1px solid #ddd;padding:6px;font-size:0.9rem}
    .small{font-size:0.85rem;color:#666}
    .actions{display:flex;gap:6px}
  </style>
</head>
<body>
  <header>
    <h1>QR Scanner</h1>
    <div class="small">Señor don Conde — QR Scanner</div>
  </header>

  <section class="controls">
    <button id="btn-start">Iniciar cámara</button>
    <button id="btn-stop" disabled>Detener</button>
    <button id="btn-clear">Borrar lista</button>
    <button id="btn-export-csv">Exportar CSV</button>
    <button id="btn-export-txt">Exportar TXT</button>
  </section>

  <div id="reader">Presione "Iniciar cámara"</div>

  <section>
    <h2>Lista de códigos</h2>
    <table id="tbl">
      <thead>
        <tr><th>#</th><th>Valor</th><th>Fecha</th><th>Acciones</th></tr>
      </thead>
      <tbody></tbody>
    </table>
  </section>

<script>
const STORAGE_KEY = 'pwa_qr_lista_v1';
let lista = JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]');
let html5QrScanner = null;
let scanning = false;

const reader = document.getElementById('reader');
const tbody = document.querySelector('#tbl tbody');
const btnStart = document.getElementById('btn-start');
const btnStop = document.getElementById('btn-stop');
const btnClear = document.getElementById('btn-clear');
const btnExportCsv = document.getElementById('btn-export-csv');
const btnExportTxt = document.getElementById('btn-export-txt');

function renderTabla(){
  tbody.innerHTML = '';
  lista.forEach((item, idx) => {
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${idx+1}</td>
      <td><pre style="margin:0;white-space:pre-wrap;">${escapeHtml(item.valor)}</pre></td>
      <td>${new Date(item.fecha).toLocaleString()}</td>
      <td class="actions">
        <button data-i="${idx}" class="btn-del">Eliminar</button>
      </td>`;
    tbody.appendChild(tr);
  });
  document.querySelectorAll('.btn-del').forEach(b=>b.onclick = ()=>{
    const i = Number(b.dataset.i);
    lista.splice(i,1);
    saveAndRender();
  });
}

function escapeHtml(s){
  return (s+'').replace(/[&<>"']/g,c=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[c]));
}

function saveAndRender(){
  localStorage.setItem(STORAGE_KEY, JSON.stringify(lista));
  renderTabla();
}

saveAndRender();

function onScanSuccess(decodedText){
  const last = lista.length ? lista[lista.length-1].valor : null;
  if(last === decodedText) return;

  lista.push({valor: decodedText, fecha: new Date().toISOString()});
  saveAndRender();
  flashMessage(`Escaneado: ${decodedText}`);
  navigator.vibrate?.(100);
}

function onScanFailure(error){}

btnStart.onclick = async ()=>{
  if(scanning) return;
  try{
    html5QrScanner = new Html5Qrcode("reader");
    await html5QrScanner.start({ facingMode: "environment" }, { fps: 10, qrbox: 250 }, onScanSuccess, onScanFailure);
    scanning = true;
    btnStart.disabled = true; btnStop.disabled = false;
  }catch(e){
    alert('No se pudo iniciar la cámara: ' + e);
  }
};

btnStop.onclick = async ()=>{
  if(!scanning || !html5QrScanner) return;
  await html5QrScanner.stop();
  html5QrScanner.clear();
  reader.textContent = 'Presione "Iniciar cámara"';
  scanning = false;
  btnStart.disabled = false; btnStop.disabled = true;
};

btnClear.onclick = ()=>{
  if(!confirm('Borrar toda la lista?')) return;
  lista = [];
  saveAndRender();
};

function downloadBlob(content, filename, mime){
  const blob = new Blob([content], { type: mime });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url; a.download = filename; a.click();
  URL.revokeObjectURL(url);
}

btnExportCsv.onclick = ()=>{
  if(!lista.length){ alert('La lista está vacía'); return; }
  const header = 'valor,fecha\n';
  const rows = lista.map(i => `"${i.valor.replace(/"/g,'""')}","${i.fecha}"`).join('\n');
  downloadBlob(header + rows, 'codigos.csv', 'text/csv');
};

btnExportTxt.onclick = ()=>{
  if(!lista.length){ alert('La lista está vacía'); return; }
  const content = lista.map(i => `${i.valor}\t${i.fecha}`).join('\n');
  downloadBlob(content, 'codigos.txt', 'text/plain');
};

function flashMessage(msg){
  const el = document.createElement('div');
  el.textContent = msg;
  el.style.position='fixed';
  el.style.right='12px';
  el.style.bottom='12px';
  el.style.padding='8px 12px';
  el.style.background='#222';
  el.style.color='#fff';
  el.style.borderRadius='8px';
  document.body.appendChild(el);
  setTimeout(()=>el.remove(),1600);
}

if('serviceWorker' in navigator){
  navigator.serviceWorker.register('/sw.js');
}
</script>

</body>
</html>
